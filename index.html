<!DOCTYPE html>
<html lang="sq">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Exterminator - Paneli</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Fshijmë inputin e numrit shigjetat */
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="text-gray-800">

    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-900">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-96">
            <div class="text-center mb-6">
                <img src="https://i.imgur.com/cMRJk4p.png" alt="Logo" class="h-16 mx-auto mb-2">
                <h2 class="text-2xl font-bold text-gray-800">Doctor Exterminator</h2>
                <p class="text-sm text-gray-500">Kyçuni në sistem</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="email" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Fjalëkalimi</label>
                    <input type="password" id="password" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div id="login-error" class="text-red-500 text-sm hidden"></div>
                <button onclick="handleLogin()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition">
                    Hyni
                </button>
            </div>
        </div>
    </div>

    <div id="dashboard" class="hidden min-h-screen flex flex-col">
        <nav class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-50">
            <div class="flex items-center space-x-3">
                <img src="https://i.imgur.com/cMRJk4p.png" alt="Logo" class="h-10">
                <span class="font-bold text-xl hidden sm:block">Doctor Exterminator</span>
            </div>
            <div class="flex items-center space-x-4">
                <span id="user-email-display" class="text-sm text-gray-600 hidden sm:block"></span>
                <button onclick="handleLogout()" class="text-red-600 hover:text-red-800 font-medium text-sm">
                    <i class="fas fa-sign-out-alt"></i> Dil
                </button>
            </div>
        </nav>

        <main class="flex-grow container mx-auto p-4 md:p-6 max-w-5xl space-y-8">
            
            <div class="bg-white rounded-xl shadow-lg p-6 border-t-4 border-blue-600">
                <h3 class="text-xl font-bold mb-4 flex items-center"><i class="fas fa-plus-circle text-blue-600 mr-2"></i> Krijo Vërtetim të Ri</h3>
                
                <form id="ddd-form" onsubmit="event.preventDefault(); saveClient();" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="col-span-1 md:col-span-2">
                        <label class="block text-xs font-bold text-gray-500 uppercase">Emri i Klientit / Subjektit</label>
                        <input type="text" id="klienti" required class="w-full p-3 bg-gray-50 border border-gray-300 rounded focus:bg-white focus:border-blue-500 outline-none transition">
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase">Adresa / Lokacioni</label>
                        <input type="text" id="adresa" required class="w-full p-3 bg-gray-50 border border-gray-300 rounded focus:bg-white focus:border-blue-500 outline-none transition">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase">Qyteti</label>
                        <select id="qyteti" class="w-full p-3 bg-gray-50 border border-gray-300 rounded focus:bg-white focus:border-blue-500 outline-none">
                            <option>Ferizaj</option><option>Prishtinë</option><option>Gjilan</option><option>Prizren</option><option>Pejë</option><option>Gjakovë</option><option>Mitrovicë</option><option>Lipjan</option><option>Shtime</option><option>Kaçanik</option><option>Viti</option><option>Podujevë</option><option>Fushë Kosovë</option><option>Tjetër</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase">Data e Kryerjes</label>
                        <input type="date" id="data_kryerjes" required class="w-full p-3 bg-gray-50 border border-gray-300 rounded focus:bg-white focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase">Ora e fillimit</label>
                        <input type="time" id="ora" required class="w-full p-3 bg-gray-50 border border-gray-300 rounded focus:bg-white focus:border-blue-500 outline-none">
                    </div>

                    <div class="col-span-1 md:col-span-2 bg-gray-50 p-4 rounded border border-gray-200">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Lloji i Shërbimit</label>
                        <div class="grid grid-cols-2 gap-2" id="sherbimet-container">
                            </div>
                    </div>

                    <div class="col-span-1 md:col-span-2 bg-gray-50 p-4 rounded border border-gray-200">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Preparati i Përdorur (Kimikati)</label>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-2" id="preparatet-container">
                            </div>
                    </div>

                    <div class="col-span-1 md:col-span-2 bg-gray-50 p-4 rounded border border-gray-200">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Dëmtuesit e Trajtuar</label>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2" id="demtuesit-container">
                            </div>
                    </div>

                    <div class="col-span-1 md:col-span-2">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Detajet e Trajtimit</label>
                        <table class="w-full text-sm text-left text-gray-500 border">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                <tr>
                                    <th class="px-2 py-2">Hapësira / Zona</th>
                                    <th class="px-2 py-2">Monitorimi</th>
                                    <th class="px-2 py-2">Veprimi</th>
                                </tr>
                            </thead>
                            <tbody id="zona-body">
                                </tbody>
                        </table>
                        <button type="button" onclick="shtoRjesht()" class="mt-2 text-xs text-blue-600 hover:underline">+ Shto Rresht</button>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase">Emri i Teknikut</label>
                        <input type="text" id="tekniku" placeholder="p.sh. Visar Fera" required class="w-full p-3 bg-gray-50 border border-gray-300 rounded focus:bg-white focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase">Emri i Pranuesit</label>
                        <input type="text" id="pranuesi" required class="w-full p-3 bg-gray-50 border border-gray-300 rounded focus:bg-white focus:border-blue-500 outline-none">
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase">Vlefshmëria (Garancioni)</label>
                        <select id="vlefshmeria" class="w-full p-3 bg-gray-50 border border-gray-300 rounded focus:bg-white focus:border-blue-500 outline-none">
                            <option value="1 Muaj">1 Muaj</option>
                            <option value="2 Muaj">2 Muaj</option>
                            <option value="3 Muaj">3 Muaj</option>
                            <option value="4 Muaj">4 Muaj</option>
                            <option value="5 Muaj">5 Muaj</option>
                            <option value="6 Muaj" selected>6 Muaj</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase flex justify-between">
                            <span>Çmimi (€)</span>
                            <div class="flex items-center space-x-1">
                                <input type="checkbox" id="cmimi_na" onchange="togglePriceInput()" class="form-checkbox h-3 w-3 text-blue-600">
                                <span class="text-[10px] text-gray-400">N/A</span>
                            </div>
                        </label>
                        <input type="number" id="cmimi" class="w-full p-3 bg-gray-50 border border-gray-300 rounded focus:bg-white focus:border-blue-500 outline-none">
                    </div>

                    <div class="col-span-1 md:col-span-2 pt-4 flex gap-4">
                        <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded shadow-lg transition transform hover:scale-105">
                            <i class="fas fa-save mr-2"></i> Ruaj Klientin
                        </button>
                    </div>
                </form>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 border-t-4 border-gray-600">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold flex items-center"><i class="fas fa-list text-gray-600 mr-2"></i> Lista e Klientëve</h3>
                    <input type="text" id="search" placeholder="Kërko klient..." class="p-2 border rounded text-sm w-1/3">
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                            <tr>
                                <th class="px-4 py-3">Data</th>
                                <th class="px-4 py-3">Klienti</th>
                                <th class="px-4 py-3">Qyteti</th>
                                <th class="px-4 py-3 text-right">Veprime</th>
                            </tr>
                        </thead>
                        <tbody id="clients-list">
                            <tr><td colspan="4" class="text-center py-4"><div class="loader"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>

        <footer class="bg-gray-800 text-white p-4 mt-auto">
            <div class="container mx-auto flex flex-col md:flex-row justify-center items-center space-y-2 md:space-y-0 md:space-x-4">
                <img src="https://i.imgur.com/oksiI1G.png" alt="Veros Logo" style="height: 30px;">
                <span class="text-sm font-light opacity-80">© 2026 Zhvilluar nga VEROS</span>
            </div>
        </footer>
    </div>

    <script type="module">
        // ------------------------------------------------------------------
        // 1. IMPORTET E KONSOLIDUARA (Vetëm një herë)
        // ------------------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, getDoc, query, orderBy, Timestamp } 
            from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } 
            from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
        import { jsPDF } from "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js";

        // ------------------------------------------------------------------
        // 2. KONFIGURIMI I FIREBASE (Doctor Exterminator)
        // ------------------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyDF5NmnA6XPkhp4TIgHWlnYXCZ3SIlImpk",
            authDomain: "doctor-1a7e9.firebaseapp.com",
            projectId: "doctor-1a7e9",
            storageBucket: "doctor-1a7e9.firebasestorage.app",
            messagingSenderId: "504795476577",
            appId: "1:504795476577:web:3105bd2a36860bff0c7020"
        };

        // Inicimi
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // ------------------------------------------------------------------
        // 3. TË DHËNAT STATIKE (Listat)
        // ------------------------------------------------------------------
        const sherbimet = ["Dezinsektim", "Dezinfektim", "Deratizim", "Repelim"];
        const demtuesit = ["Buburreca", "Milingona", "Miza", "Mushkonja", "Grerëza/Bletë", "Pleshta", "Çimka", "Merimanga", "Akrepa", "Minjë/Miu", "Gjarpërinjë", "Tjetër"];
        
        // LISTA E RE E KËRKUAR
        const preparatet = [
            "Difethialone", "Acid boric", "Silica gel", "Hydramethylnon", "Clothianidine", 
            "Abamectin", "Sodium Tethraborate Decahydrate (Borax)", "Lambda-cyhalothrin", 
            "Pyriproxifen", "Permethrin", "Imidacloprid", "Deltamethrin", 
            "Pyrethrins-Piperonyl Butoxide", "Didecyldimethyl ammonium chloride"
        ];

        let currentUserRole = 'user'; // default

        // ------------------------------------------------------------------
        // 4. LOGJIKA E AUTH & ROLET (Admin vs User)
        // ------------------------------------------------------------------
        
        // Kontrollo statusin e userit
        onAuthStateChanged(auth, async (user) => {
            const loginScreen = document.getElementById('login-screen');
            const dashboard = document.getElementById('dashboard');
            const emailDisplay = document.getElementById('user-email-display');

            if (user) {
                // Useri është i kyçur
                emailDisplay.innerText = user.email;
                loginScreen.classList.add('hidden');
                dashboard.classList.remove('hidden');

                // Kontrollo Rolin në Firestore
                try {
                    const userDocRef = doc(db, "users", user.email);
                    const userDoc = await getDoc(userDocRef);
                    
                    if (userDoc.exists() && userDoc.data().roli === 'admin') {
                        currentUserRole = 'admin';
                        console.log("Roli: Admin");
                    } else {
                        currentUserRole = 'user';
                        console.log("Roli: User Standard");
                    }
                    
                    // Ngarko klientët pasi kemi rolin
                    loadClients();

                } catch (error) {
                    console.error("Gabim gjatë marrjes së rolit:", error);
                    currentUserRole = 'user'; // fallback
                    loadClients();
                }

            } else {
                // Useri nuk është i kyçur
                loginScreen.classList.remove('hidden');
                dashboard.classList.add('hidden');
            }
        });

        // Funksioni Login
        async function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');

            try {
                errorDiv.classList.add('hidden');
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                errorDiv.innerText = "Gabim: Email ose fjalëkalim i pasaktë.";
                errorDiv.classList.remove('hidden');
                console.error(error);
            }
        }

        // Funksioni Logout
        async function handleLogout() {
            await signOut(auth);
            location.reload();
        }

        // ------------------------------------------------------------------
        // 5. MENAXHIMI I UI (Mbushja e listave)
        // ------------------------------------------------------------------
        
        // Mbush Checkbox-at
        function fillCheckboxes(containerId, list, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = list.map(item => `
                <label class="flex items-center space-x-2 text-xs">
                    <input type="checkbox" name="${type}" value="${item}" class="form-checkbox h-4 w-4 text-blue-600 rounded">
                    <span>${item}</span>
                </label>
            `).join('');
        }

        fillCheckboxes('sherbimet-container', sherbimet, 'sherbimi');
        fillCheckboxes('preparatet-container', preparatet, 'preparati');
        fillCheckboxes('demtuesit-container', demtuesit, 'demtuesi');
        
        // Vendos datën sot
        document.getElementById('data_kryerjes').valueAsDate = new Date();

        // Shto Rresht në tabelë
        function shtoRjesht() {
            const tbody = document.getElementById('zona-body');
            const row = document.createElement('tr');
            row.className = "bg-white border-b hover:bg-gray-50";
            row.innerHTML = `
                <td class="p-2"><input type="text" class="w-full border-b border-gray-300 focus:border-blue-500 outline-none text-xs" placeholder="psh. Kuzhina"></td>
                <td class="p-2"><input type="text" class="w-full border-b border-gray-300 focus:border-blue-500 outline-none text-xs" placeholder="psh. I pastër"></td>
                <td class="p-2"><input type="text" class="w-full border-b border-gray-300 focus:border-blue-500 outline-none text-xs" placeholder="psh. Gel"></td>
            `;
            tbody.appendChild(row);
        }
        // Shto një rresht default
        shtoRjesht();

        // Logjika e Çmimit N/A
        function togglePriceInput() {
            const checkbox = document.getElementById('cmimi_na');
            const input = document.getElementById('cmimi');
            if (checkbox.checked) {
                input.value = '';
                input.disabled = true;
                input.placeholder = "N/A";
                input.classList.add('bg-gray-200');
            } else {
                input.disabled = false;
                input.placeholder = "";
                input.classList.remove('bg-gray-200');
            }
        }

        // ------------------------------------------------------------------
        // 6. OPERACIONET E DATABAZËS (Save, Load, Delete)
        // ------------------------------------------------------------------

        // Ruaj Klientin
        async function saveClient() {
            const getChecked = (name) => Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(el => el.value);
            
            // Merr të dhënat nga tabela
            const zonat = Array.from(document.querySelectorAll('#zona-body tr')).map(tr => {
                const inputs = tr.querySelectorAll('input');
                return { zona: inputs[0].value, monitorimi: inputs[1].value, veprimi: inputs[2].value };
            }).filter(z => z.zona || z.monitorimi || z.veprimi);

            const cmimiNa = document.getElementById('cmimi_na').checked;
            const cmimiVal = document.getElementById('cmimi').value;

            const data = {
                klienti: document.getElementById('klienti').value,
                adresa: document.getElementById('adresa').value,
                qyteti: document.getElementById('qyteti').value,
                data_kryerjes: document.getElementById('data_kryerjes').value,
                ora: document.getElementById('ora').value,
                tekniku: document.getElementById('tekniku').value,
                pranuesi: document.getElementById('pranuesi').value,
                vlefshmeria: document.getElementById('vlefshmeria').value,
                sherbimet: getChecked('sherbimi'),
                preparatet: getChecked('preparati'),
                demtuesit: getChecked('demtuesi'),
                zonat: zonat,
                cmimi: cmimiNa ? "N/A" : (cmimiVal ? cmimiVal + " €" : ""),
                timestamp: Timestamp.now()
            };

            try {
                await addDoc(collection(db, "clients"), data);
                alert("Klienti u ruajt me sukses!");
                document.getElementById('ddd-form').reset();
                shtoRjesht(); // Reseto tabelën
                loadClients();
            } catch (e) {
                console.error("Error adding document: ", e);
                alert("Gabim gjatë ruajtjes!");
            }
        }

        // Ngarko Klientët (dhe shfaq/fshih butonin Menaxho sipas rolit)
        async function loadClients() {
            const list = document.getElementById('clients-list');
            list.innerHTML = '<tr><td colspan="4" class="text-center py-4"><div class="loader"></div></td></tr>';
            
            const q = query(collection(db, "clients"), orderBy("timestamp", "desc"));
            const querySnapshot = await getDocs(q);
            
            list.innerHTML = '';
            querySnapshot.forEach((doc) => {
                const client = doc.data();
                
                // Butoni Menaxho (Fshije) - Vetëm nëse roli është ADMIN
                let deleteButtonHTML = '';
                if (currentUserRole === 'admin') {
                    deleteButtonHTML = `
                        <button onclick="deleteClient('${doc.id}')" class="text-red-500 hover:text-red-700 ml-2" title="Fshije (Admin)">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                }

                const row = `
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="px-4 py-3 font-medium">${client.data_kryerjes}</td>
                        <td class="px-4 py-3">${client.klienti}</td>
                        <td class="px-4 py-3">${client.qyteti}</td>
                        <td class="px-4 py-3 text-right">
                            <button onclick='generatePDF(${JSON.stringify(client).replace(/'/g, "&#39;")})' class="text-blue-600 hover:text-blue-800 font-medium">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                            ${deleteButtonHTML}
                        </td>
                    </tr>
                `;
                list.innerHTML += row;
            });
        }

        // Fshij Klientin (Vetëm Admin)
        async function deleteClient(id) {
            if(!confirm("A jeni i sigurt që doni ta fshini këtë klient?")) return;
            try {
                await deleteDoc(doc(db, "clients", id));
                loadClients();
            } catch (e) {
                alert("Nuk keni autorizim për të fshirë!");
                console.error(e);
            }
        }

        // ------------------------------------------------------------------
        // 7. GJENERIMI I PDF (LOGJIKA KRYESORE)
        // ------------------------------------------------------------------
        window.generatePDF = async (client) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Load Images (Helper function)
            const loadImage = (src) => new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = "Anonymous"; 
                img.onload = () => resolve(img);
                img.onerror = () => resolve(null);
                img.src = src;
            });

            const logoImg = await loadImage("https://i.imgur.com/cMRJk4p.png");
            const vulaImg = await loadImage("https://i.imgur.com/0FbFlq8.png");
            
            // Header
            if (logoImg) doc.addImage(logoImg, 'PNG', 10, 10, 50, 20);
            
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text("DOCTOR EXTERMINATOR", 150, 15, { align: "right" });
            doc.text("NUI: 811498957", 150, 20, { align: "right" });
            doc.text("Tel: 044 158 638", 150, 25, { align: "right" });

            doc.setDrawColor(0);
            doc.line(10, 32, 200, 32);

            // Title
            doc.setFontSize(16);
            doc.setTextColor(0);
            doc.text("RAPORT I SHËRBIMIT DDD", 105, 42, { align: "center" });

            // Info Box
            doc.setFillColor(240, 240, 240);
            doc.rect(10, 50, 190, 35, 'F');
            doc.setFontSize(11);
            
            doc.text(`Klienti: ${client.klienti}`, 15, 60);
            doc.text(`Adresa: ${client.adresa}`, 15, 68);
            doc.text(`Qyteti: ${client.qyteti}`, 15, 76);
            
            doc.text(`Data: ${client.data_kryerjes}`, 120, 60);
            doc.text(`Ora: ${client.ora}`, 120, 68);

            // Services Grid
            let yPos = 95;
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text("SHËRBIMET E KRYERA:", 10, yPos);
            doc.setFont(undefined, 'normal');
            yPos += 7;
            doc.text(client.sherbimet.join(", ") || "Asnjë", 15, yPos);
            
            yPos += 15;
            doc.setFont(undefined, 'bold');
            doc.text("DËMTUESIT:", 10, yPos);
            doc.setFont(undefined, 'normal');
            yPos += 7;
            doc.text(client.demtuesit.join(", ") || "Asnjë", 15, yPos);

            yPos += 15;
            doc.setFont(undefined, 'bold');
            doc.text("PREPARATET (KIMIKATET):", 10, yPos);
            doc.setFont(undefined, 'normal');
            yPos += 7;
            // Handle long chemical names wrap
            const splitChems = doc.splitTextToSize(client.preparatet.join(", ") || "Asnjë", 180);
            doc.text(splitChems, 15, yPos);
            yPos += (splitChems.length * 5) + 5;

            // Table Header
            doc.setFillColor(50, 50, 50);
            doc.setTextColor(255, 255, 255);
            doc.rect(10, yPos, 190, 8, 'F');
            doc.text("ZONA", 15, yPos + 5.5);
            doc.text("MONITORIMI", 80, yPos + 5.5);
            doc.text("VEPRIMI", 140, yPos + 5.5);
            yPos += 10;

            // Table Rows
            doc.setTextColor(0);
            if(client.zonat && client.zonat.length > 0) {
                client.zonat.forEach(row => {
                    doc.text(row.zona || "-", 15, yPos);
                    doc.text(row.monitorimi || "-", 80, yPos);
                    doc.text(row.veprimi || "-", 140, yPos);
                    doc.line(10, yPos + 2, 200, yPos + 2); // underline
                    yPos += 7;
                });
            } else {
                doc.text("Nuk ka detaje shtesë.", 15, yPos);
                yPos += 10;
            }

            // Footer Section
            yPos = 240; // Push to bottom
            
            // Validity & Price
            doc.setFont(undefined, 'bold');
            // Zëvendësojmë tekstin statik '6 Muaj' me atë dinamik
            doc.text(`Garancioni: ${client.vlefshmeria || "6 Muaj"}`, 15, yPos); 
            doc.text(`Çmimi: ${client.cmimi}`, 150, yPos);
            doc.setFont(undefined, 'normal');

            yPos += 15;
            
            // Signatures (BLUE INK)
            doc.setTextColor(0, 0, 205); // Blue color #0000CD
            doc.text("_______________________", 20, yPos);
            doc.text("_______________________", 140, yPos);
            
            yPos += 5;
            doc.setTextColor(0); // Back to black for text
            doc.setFontSize(9);
            // SWAPPED: Teknik left, Pranues right
            doc.text(`TEKNIKU: ${client.tekniku}`, 25, yPos);
            doc.text(`PRANUESI: ${client.pranuesi}`, 145, yPos);

            // Stamp (Vula) - Centered between signatures
            if (vulaImg) {
                doc.addImage(vulaImg, 'PNG', 85, yPos - 25, 30, 30);
            }

            // Disclaimer
            yPos += 15;
            doc.setFontSize(7);
            doc.setTextColor(100);
            doc.text("Vërejtje: Pas trajtimit, ambientet të ajrosen për 30 minuta. Mbani larg fëmijët dhe kafshët gjatë procesit.", 105, yPos, {align:"center"});

            doc.save(`${client.klienti}_Raport.pdf`);
        }

        // ------------------------------------------------------------------
        // 8. EXPOSE FUNCTIONS TO WINDOW (CRITICAL FIX)
        // ------------------------------------------------------------------
        window.handleLogin = handleLogin;
        window.handleLogout = handleLogout;
        window.saveClient = saveClient;
        window.deleteClient = deleteClient;
        window.generatePDF = window.generatePDF;
        window.shtoRjesht = shtoRjesht;
        window.togglePriceInput = togglePriceInput;

    </script>
</body>
</html>
