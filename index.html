<!DOCTYPE html>
<html lang="sq">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sistemi DOCTOR EXTERMINATOR - Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            padding-bottom: env(safe-area-inset-bottom);
        }

        input,
        select,
        textarea {
            font-size: 16px !important;
        }

        .doc-line {
            border-bottom: 1px solid #000;
            display: inline-block;
            padding: 0 4px;
            min-height: 1.2em;
        }

        .checkbox-box {
            width: 14px;
            height: 14px;
            border: 1px solid black;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 6px;
            font-size: 10px;
            font-weight: bold;
        }

        #pdf-render-zone {
            border: 2px solid #000;
        }

        /* Remove arrows from number input */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        @media print {
            .no-print {
                display: none !important;
            }
        }

        /* Black & White Theme Overrides */
        .btn-black {
            background-color: #000000;
            color: white;
        }

        .btn-black:hover {
            background-color: #333333;
        }

        .border-black-theme {
            border-color: #000000;
        }

        .text-black-theme {
            color: #000000;
        }

        .accent-black-theme {
            accent-color: #000000;
        }
    </style>
</head>

<body class="bg-white min-h-screen text-black">
    <div id="app">
        <!-- LOGIN VIEW -->
        <div id="login-view" class="min-h-screen flex flex-col items-center justify-center p-6 bg-white">
            <div class="w-full max-w-md">
                <img src="https://i.imgur.com/cMRJk4p.png" crossorigin="anonymous" alt="Logo"
                    class="w-64 mx-auto mb-12">
                <div class="bg-gray-50 p-8 rounded-3xl border-2 border-black shadow-2xl">
                    <h2 class="text-2xl font-black uppercase mb-6 text-center">Identifikohu</h2>
                    <div class="space-y-4">
                        <input type="email" id="login-email" placeholder="E-mail"
                            class="w-full p-4 border-2 border-gray-300 rounded-xl font-bold focus:border-black outline-none">
                        <input type="password" id="login-password" placeholder="Fjalëkalimi"
                            class="w-full p-4 border-2 border-gray-300 rounded-xl font-bold focus:border-black outline-none">
                        <button onclick="handleLogin()"
                            class="w-full bg-black text-white p-4 rounded-xl font-black uppercase shadow-lg border-b-4 border-gray-800 hover:scale-[1.02] transition-all">Hyni</button>
                    </div>
                    <div id="login-error"
                        class="hidden mt-4 p-3 bg-red-100 border-2 border-red-600 rounded-xl text-red-600 font-bold text-sm text-center">
                    </div>
                </div>
                <div
                    class="mt-16 flex items-center justify-center gap-2 text-[10px] text-zinc-500 font-bold uppercase tracking-wider">
                    <span>© 2026 Zhvilluar nga</span>
                    <img src="https://i.imgur.com/oksiI1G.png" style="height: 22px;" alt="VEROS">
                    <span>VEROS</span>
                </div>
            </div>
        </div>
        <div id="dashboard-view"
            class="hidden min-h-screen flex flex-col items-center justify-center p-6 pb-20 bg-white">
            <div class="absolute top-4 right-4 md:top-6 md:right-6 flex items-center space-x-2">
                <button onclick="openPasswordModal()"
                    class="bg-blue-900 text-white p-2 md:px-6 md:py-2 rounded-xl font-bold text-sm uppercase shadow-lg border-b-4 border-blue-950 hover:scale-[1.02] transition-all flex items-center gap-2">
                    <i class="fas fa-key"></i> <span class="hidden md:inline">Fjalëkalimi</span>
                </button>
                <button onclick="handleLogout()"
                    class="bg-blue-900 text-white p-2 md:px-6 md:py-2 rounded-xl font-bold text-sm uppercase shadow-lg border-b-4 border-blue-950 hover:scale-[1.02] transition-all flex items-center gap-2">
                    <i class="fas fa-sign-out-alt"></i> <span class="hidden md:inline">Dil</span>
                </button>
            </div>
            <div class="mb-12 text-center">
                <img src="https://i.imgur.com/cMRJk4p.png" crossorigin="anonymous" alt="Logo" class="w-64 mx-auto mb-8">
                <h1 class="text-3xl font-black text-black tracking-tighter mb-2 uppercase">DOCTOR EXTERMINATOR DDD SHPK
                </h1>
                <p class="text-gray-500 font-bold text-lg uppercase tracking-widest">Paneli i Kontrollit</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-4xl">
                <button onclick="createNew()"
                    class="group bg-black text-white p-8 rounded-3xl shadow-2xl hover:scale-[1.02] transition-all flex flex-col items-center justify-center gap-4 border-b-4 border-gray-800">
                    <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center"><i
                            class="fas fa-plus text-3xl"></i></div>
                    <span class="text-xl font-black uppercase">+ Shto Vërtetim</span>
                </button>
                <button id="btn-client-mgmt" onclick="showClientManagement()" style="display: none;"
                    class="group bg-gray-900 text-white p-8 rounded-3xl shadow-2xl hover:scale-[1.02] transition-all flex flex-col items-center justify-center gap-4 border-b-4 border-black">
                    <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center"><i
                            class="fas fa-users-cog text-3xl"></i></div>
                    <span class="text-xl font-black uppercase">Menaxho Klientët</span>
                </button>

                <!-- RED ALERT BUTTON -->
                <button onclick="showPanicList()"
                    class="group bg-[#dc3545] text-white p-8 rounded-3xl shadow-2xl hover:scale-[1.02] transition-all flex flex-col items-center justify-center gap-4 relative border-b-4 border-red-900">
                    <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center"><i
                            class="fas fa-exclamation-triangle text-3xl text-white"></i></div>
                    <span class="text-xl font-black uppercase">⚠️ Ri-intervenim</span>
                    <span id="dash-expired-count"
                        class="absolute top-6 right-6 bg-white text-[#dc3545] font-black px-3 py-1 rounded-full text-sm shadow-lg">0</span>
                </button>

                <button onclick="showList()"
                    class="group bg-gray-700 text-white p-8 rounded-3xl shadow-2xl hover:scale-[1.02] transition-all flex flex-col items-center justify-center gap-4 border-b-4 border-black">
                    <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center"><i
                            class="fas fa-folder-open text-3xl"></i></div>
                    <span class="text-xl font-black uppercase">Vërtetimet e Lëshuara</span>
                </button>
            </div>

            <div
                class="mt-16 flex items-center justify-center gap-2 text-[10px] text-zinc-500 font-bold uppercase tracking-wider">
                <span>© 2026 Zhvilluar nga</span>
                <img src="https://i.imgur.com/oksiI1G.png" style="height: 22px;" alt="VEROS">
                <span>VEROS</span>
            </div>
        </div>

        <!-- LIST VIEW -->
        <div id="list-view" class="hidden max-w-5xl mx-auto py-10 px-4 bg-white min-h-screen">
            <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                <button onclick="showDashboard()"
                    class="bg-black text-white px-8 py-3 rounded-xl font-black uppercase transition-all shadow-lg flex items-center gap-2 border-b-4 border-gray-800"><i
                        class="fas fa-arrow-left"></i> Kthehu</button>
                <input type="text" id="search-input" oninput="renderList()"
                    class="flex-1 p-4 bg-gray-50 border-2 border-black rounded-2xl font-bold text-lg outline-none focus:bg-white"
                    placeholder="Kërko klientin...">
            </div>
            <div class="overflow-x-auto bg-white rounded-2xl shadow-xl border-2 border-black">
                <table class="w-full text-left">
                    <tr class="bg-black text-white text-[11px] uppercase font-black tracking-wider">
                        <th class="p-4">Nr.</th>
                        <th class="p-4">Data</th>
                        <th class="p-4">Klienti</th>
                        <th class="p-4">Lëshuar nga</th>
                        <th class="p-4">Çmimi</th>
                        <th class="p-4 text-center">Veprimet</th>
                    </tr>
                    <tbody id="docs-list" class="text-sm font-bold"></tbody>
                </table>
            </div>
        </div>

        <!-- EDIT VIEW -->
        <div id="edit-view" class="hidden bg-white min-h-screen pb-20">
            <div class="border-b-2 border-black sticky top-0 bg-white/95 backdrop-blur-md z-10 px-6 py-4 shadow-sm">
                <div class="max-w-6xl mx-auto flex justify-between items-center">
                    <button onclick="showList()"
                        class="text-black font-black flex items-center gap-2 uppercase tracking-tight hover:underline"><i
                            class="fas fa-arrow-left"></i> Anulo</button>
                    <div class="flex items-center gap-4">
                        <button onclick="saveData()"
                            class="bg-black text-white px-8 py-3 rounded-xl font-black shadow-lg uppercase tracking-wide flex items-center gap-2 border-b-4 border-gray-800 active:translate-y-1"><i
                                class="fas fa-save"></i> RUAJ</button>
                    </div>
                </div>
            </div>
            <div class="max-w-6xl mx-auto p-6 space-y-8">
                <!-- Info Grid -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 bg-gray-50 p-6 rounded-2xl border-2 border-black">
                    <div><label
                            class="block text-[10px] font-black text-black uppercase mb-2 tracking-wider">Data</label><input
                            type="date" id="f-data"
                            class="w-full p-3 border-2 border-gray-300 rounded-xl font-bold focus:border-black outline-none">
                    </div>
                    <div><label
                            class="block text-[10px] font-black text-black uppercase mb-2 tracking-wider">Ora</label><input
                            type="time" id="f-ora"
                            class="w-full p-3 border-2 border-gray-300 rounded-xl font-bold focus:border-black outline-none">
                    </div>
                    <div><label class="block text-[10px] font-black text-black uppercase mb-2 tracking-wider">Nr.
                            Vërtetimit</label><input type="text" id="f-nr-v"
                            class="w-full p-3 border-2 border-gray-300 rounded-xl font-bold focus:border-black outline-none">
                    </div>
                </div>

                <!-- Client Info -->
                <div class="space-y-4">
                    <label
                        class="block text-xs font-black text-black uppercase tracking-widest border-b-2 border-black pb-2">Informacionet
                        e Klientit</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2 relative">
                            <label class="block text-[10px] font-bold text-gray-500 mb-1">KLIENTI</label>
                            <input type="text" id="f-klienti" autocomplete="off"
                                class="w-full p-4 bg-gray-50 border-2 border-black rounded-xl font-black uppercase outline-none text-lg"
                                placeholder="Kërko ose shto emrin..." oninput="handleFuzzySearch(this.value)">
                            <div id="fuzzy-results"
                                class="hidden absolute left-0 right-0 top-full mt-2 bg-white border-2 border-black rounded-2xl shadow-2xl z-50 max-h-60 overflow-y-auto font-bold uppercase">
                            </div>
                        </div>
                        <div><label class="block text-[10px] font-bold text-gray-500 mb-1">ADRESA</label><input
                                type="text" id="f-adresa"
                                class="w-full p-3 bg-white border-2 border-gray-300 rounded-xl font-bold uppercase focus:border-black outline-none">
                        </div>
                        <div><label class="block text-[10px] font-bold text-gray-500 mb-1">NUI</label><input type="text"
                                id="f-nui"
                                class="w-full p-3 bg-white border-2 border-gray-300 rounded-xl font-bold uppercase focus:border-black outline-none">
                        </div>
                        <div><label class="block text-[10px] font-bold text-gray-500 mb-1">E-MAIL
                                (Opsional)</label><input type="email" id="f-email"
                                class="w-full p-3 bg-white border-2 border-gray-300 rounded-xl font-bold uppercase focus:border-black outline-none">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-[10px] font-bold text-gray-500 mb-1">M²</label><input
                                    type="text" id="f-m2"
                                    class="w-full p-3 bg-white border-2 border-gray-300 rounded-xl font-bold focus:border-black outline-none">
                            </div>
                            <div><label class="block text-[10px] font-bold text-gray-500 mb-1">TEL</label><input
                                    type="text" id="f-tel"
                                    class="w-full p-3 bg-white border-2 border-gray-300 rounded-xl font-bold focus:border-black outline-none">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Services -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 pt-4">
                    <div>
                        <label
                            class="block text-xs font-black text-black uppercase tracking-widest border-b-2 border-black pb-2 mb-4">Shërbimet</label>
                        <div class="grid grid-cols-1 gap-2" id="sh-inputs"></div>
                    </div>
                    <div>
                        <label
                            class="block text-xs font-black text-black uppercase tracking-widest border-b-2 border-black pb-2 mb-4">Pestat</label>
                        <div class="grid grid-cols-2 gap-2" id="pest-inputs"></div>
                    </div>
                </div>

                <!-- Preps & Methods -->
                <div class="pt-6 border-t-2 border-gray-100">
                    <div class="flex justify-between items-center mb-4"><label
                            class="block text-xs font-black text-black uppercase tracking-widest">Preparatet</label><button
                            onclick="addNewPrepField()"
                            class="text-black text-[10px] font-black uppercase hover:underline">+ Shto manual</button>
                    </div>
                    <div id="prep-inputs" class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4"></div>
                    <div id="custom-prep-container" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
                </div>

                <div class="pt-6 border-t-2 border-gray-100 grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div><label class="block text-xs font-black text-black uppercase tracking-widest mb-4">Metoda e
                            Aplikimit</label>
                        <div class="flex flex-wrap gap-3" id="metoda-inputs"></div>
                    </div>
                    <div><label
                            class="block text-xs font-black text-black uppercase tracking-widest mb-4">Shënime</label><textarea
                            id="f-shenime"
                            class="w-full p-3 bg-gray-50 border-2 border-gray-300 rounded-xl h-24 font-bold text-sm focus:border-black outline-none"></textarea>
                    </div>
                    <div><label class="block text-xs font-black text-black uppercase tracking-widest mb-4">Çmimi
                            (€)</label>
                        <div class="flex items-center gap-3">
                            <input type="number" id="f-cmimi"
                                class="flex-1 p-4 bg-gray-50 border-2 border-black rounded-xl font-black text-xl"
                                inputmode="decimal" step="0.01">
                            <label
                                class="flex items-center gap-2 cursor-pointer bg-gray-50 px-4 py-3 rounded-xl border-2 border-gray-200 hover:border-black transition-all">
                                <input type="checkbox" id="f-price-na" class="w-5 h-5 accent-black"
                                    onchange="togglePriceNA(this.checked)">
                                <span class="text-xs font-black uppercase select-none">N/A</span>
                            </label>
                        </div>
                    </div>
                    <div><label class="block text-xs font-black text-black uppercase tracking-widest mb-4">Vlefshmëria
                            (Garancioni)</label>
                        <select id="f-validity"
                            class="w-full p-4 bg-gray-50 border-2 border-black rounded-xl font-black text-lg">
                            <option value="1 Muaj">1 Muaj</option>
                            <option value="2 Muaj">2 Muaj</option>
                            <option value="3 Muaj">3 Muaj</option>
                            <option value="4 Muaj">4 Muaj</option>
                            <option value="5 Muaj">5 Muaj</option>
                            <option value="6 Muaj" selected>6 Muaj</option>
                        </select>
                    </div>
                </div>

                <!-- Signatures -->
                <div class="pt-8 border-t-2 border-gray-100 space-y-6">
                    <div class="flex items-end gap-6 justify-between flex-wrap">
                        <div class="flex-1 min-w-[300px]">
                            <label class="block text-[10px] font-black text-black uppercase mb-2">Emri i
                                Teknikut</label>
                            <input type="text" id="f-tekniku-emri"
                                class="w-full p-3 bg-gray-50 border-2 border-gray-300 rounded-xl font-bold uppercase focus:border-black outline-none">
                        </div>
                        <div class="flex-1 min-w-[300px]">
                            <label class="block text-[10px] font-black text-black uppercase mb-2">Emri i Pranuesit
                                (Personi përgjegjës)</label>
                            <input type="text" id="f-pranuesi-emri"
                                class="w-full p-3 bg-gray-50 border-2 border-gray-300 rounded-xl font-bold uppercase focus:border-black outline-none">
                        </div>
                        <label
                            class="flex items-center gap-3 cursor-pointer bg-gray-50 px-5 py-3 rounded-xl border-2 border-gray-200 hover:border-black transition-all mb-[1px]">
                            <input type="checkbox" id="f-stamp-toggle" class="w-5 h-5 accent-black" checked>
                            <span class="text-xs font-black uppercase select-none">Shfaq Vulën</span>
                        </label>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div><label class="block text-[10px] font-black text-black uppercase mb-2">Nënshkrimi i
                                Teknikut</label>
                            <div class="rounded-xl bg-white h-40 border-2 border-dashed border-black relative"><canvas
                                    id="sig-tekniku" class="w-full h-full"></canvas></div><button
                                onclick="clearSig('tekniku')"
                                class="text-[10px] text-red-600 font-bold mt-2 uppercase">Pastro</button>
                        </div>
                        <div><label class="block text-[10px] font-black text-black uppercase mb-2">Nënshkrimi i Klienit
                                (Pranuesit)</label>
                            <div class="rounded-xl bg-white h-40 border-2 border-dashed border-black relative"><canvas
                                    id="sig-klienti" class="w-full h-full"></canvas></div><button
                                onclick="clearSig('klienti')"
                                class="text-[10px] text-red-600 font-bold mt-2 uppercase">Pastro</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CLIENT MGMT VIEW -->
        <div id="clients-mgmt-view" class="hidden bg-white min-h-screen">
            <div class="border-b-2 border-black sticky top-0 bg-white/95 backdrop-blur-md z-10 px-6 py-4 shadow-sm">
                <div class="max-w-5xl mx-auto flex justify-between items-center">
                    <button onclick="showDashboard()"
                        class="bg-black text-white px-6 py-2 rounded-xl font-bold text-sm uppercase">Kthehu</button>
                    <span class="font-black text-xl uppercase">Menaxho Klientët</span>
                    <button onclick="showClientForm()"
                        class="bg-black text-white px-6 py-2 rounded-xl font-bold text-sm uppercase">Shto
                        Klient</button>
                </div>
            </div>
            <div class="max-w-5xl mx-auto p-6 grid grid-cols-1 gap-4" id="clients-table-container"></div>
        </div>

        <!-- CLIENT FORM VIEW -->
        <div id="client-view" class="hidden bg-white min-h-screen">
            <div class="border-b-2 border-black sticky top-0 bg-white/95 backdrop-blur-md z-10 px-6 py-4 shadow-sm">
                <div class="max-w-xl mx-auto flex justify-between items-center">
                    <button onclick="showClientManagement()" class="text-black font-bold uppercase">Anulo</button>
                    <button onclick="handleSaveClient()"
                        class="bg-black text-white px-8 py-2.5 rounded-xl font-black uppercase shadow-lg border-b-4 border-gray-800 active:translate-y-1">Ruaj
                        Klientin</button>
                </div>
            </div>
            <div class="max-w-xl mx-auto p-6 space-y-4">
                <input type="text" id="c-klienti"
                    class="w-full p-3 bg-gray-50 border-2 border-black rounded-xl font-bold uppercase"
                    placeholder="EMRI I KLIENTIT">
                <input type="text" id="c-nui"
                    class="w-full p-3 bg-gray-50 border-2 border-black rounded-xl font-bold uppercase"
                    placeholder="NUI">
                <input type="text" id="c-adresa"
                    class="w-full p-3 bg-gray-50 border-2 border-black rounded-xl font-bold uppercase"
                    placeholder="ADRESA">
                <div class="grid grid-cols-2 gap-4"><input type="text" id="c-m2"
                        class="w-full p-3 bg-gray-50 border-2 border-black rounded-xl font-bold" placeholder="m²"><input
                        type="text" id="c-tel" class="w-full p-3 bg-gray-50 border-2 border-black rounded-xl font-bold"
                        placeholder="TEL"></div>
                <input type="email" id="c-email"
                    class="w-full p-3 bg-gray-50 border-2 border-black rounded-xl font-bold uppercase"
                    placeholder="E-MAIL I KLIENTIT">
            </div>
        </div>

        <!-- PRINT VIEW -->
        <div id="print-view" class="hidden fixed inset-0 bg-zinc-900 overflow-auto p-4 z-50">
            <div class="max-w-[21cm] mx-auto flex justify-between mb-4 sticky top-0 z-10">
                <button onclick="showList()"
                    class="bg-white/10 text-white px-6 py-2 rounded-lg font-bold">Mbyll</button>
                <button id="btn-download-pdf"
                    class="bg-black text-white px-10 py-2 rounded-lg font-bold shadow-xl border-b-4 border-gray-700 active:translate-y-1">Shkarko
                    PDF</button>
            </div>
            <div id="print-content" class="bg-white w-[21cm] min-h-[29.7cm] mx-auto shadow-2xl"></div>
        </div>
    </div>

    <!-- RENDERING ZONE -->
    <div id="pdf-render-zone"
        style="position: absolute; left: -9999px; top: -9999px; width: 800px; background: white; pointer-events: none;">
    </div>

    </div>

    <!-- PASSWORD CHANGE MODAL -->
    <div id="password-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-6">
        <div class="bg-white rounded-3xl shadow-2xl border-4 border-black p-8 w-full max-w-md">
            <h2 class="text-2xl font-black uppercase mb-6 text-center">Ndrysho Fjalëkalimin</h2>
            <div class="space-y-4">
                <input type="password" id="new-password-input" placeholder="Fjalëkalimi i ri (min. 6 karaktere)"
                    class="w-full p-4 border-2 border-gray-300 rounded-xl font-bold focus:border-black outline-none">
                <div class="flex gap-3">
                    <button onclick="saveNewPassword()"
                        class="flex-1 bg-green-600 text-white px-6 py-3 rounded-xl font-black uppercase shadow-lg border-b-4 border-green-800 hover:scale-[1.02] transition-all">
                        Ruaj
                    </button>
                    <button onclick="closePasswordModal()"
                        class="flex-1 bg-red-600 text-white px-6 py-3 rounded-xl font-black uppercase shadow-lg border-b-4 border-red-800 hover:scale-[1.02] transition-all">
                        Anulo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc as deleteFirestoreDoc, doc, query, orderBy, Timestamp, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail, updatePassword } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDF5NmnA6XPkhp4TIgHWlnYXCZ3SIlImpk",
            authDomain: "doctor-1a7e9.firebaseapp.com",
            projectId: "doctor-1a7e9",
            storageBucket: "doctor-1a7e9.firebasestorage.app",
            messagingSenderId: "504795476577",
            appId: "1:504795476577:web:3105bd2a36860bff0c7020"
        };

        const app = initializeApp(firebaseConfig);
        const firestore = getFirestore(app);
        const auth = getAuth(app);

        const SH_TYPES = ["DEZINFEKTIM", "DEZINSEKTIM", "DERATIZIM", "REPELIM", "KONTROLL", "INTERVENIM", "MONITORIMI DHE KONTROLLIMI I DËMTUESVE"];
        const PEST_TYPES = ["BAKTERE/VIRUSE/FUNGJE/SPORE", "FURRTARE", "BUBRRECA", "MUSHKONJA", "MIZA", "GREJZA", "ÇIMKA", "PLESHTA", "SILVERFISH/MILIPIDE", "BREJTËS", "GJARPËRINJË", "PËLLUMBA"];
        const METODA_TYPES = ["E LËNGSHME", "E NGURTË", "GRANULA", "PLUHUR", "SHKUMË"];
        const UNIT_TYPES = ["LITËR", "ML", "GRAM", "KILOGRAM", "COPË", "KUTIA", "NGJITËS"];
        const FIXED_PREPS = [
            "DIDECYLDIMETHYL AMMONIUM CHLORIDE",
            "QARTENARY AMMONIUM COMPUND",
            "DISDIUM CARBONATE WITH H2O2",
            "ACID BORIC",
            "SILICA GEL",
            "HYDRAMETHYLNON",
            "CLOTHIANIDINE",
            "ABAMECTIN",
            "SODIUM TETHRABORATE DECAHYDRATE (BORAX)",
            "LAMBDA-CYHALOTHRIN",
            "PYRIPROXIFEN",
            "PERMETHRIN",
            "IMIDACLOPRID",
            "DELTAMETHRIN",
            "PYRETHRINS-PIPERONYL BUTOXIDE",
            "BRODIFACOUM",
            "BROMADIOLONE",
            "DIFETHIALONE"
        ];
        const DEFAULT_NOTE = "Shërbimi u krye sipas standardeve dhe protokolleve ekologjike të kërkuara për trajtimin e hapësirave.";
        const LOGO_URL = 'https://i.imgur.com/cMRJk4p.png';
        const STAMP_URL = 'https://i.imgur.com/0FbFlq8.png';

        let db = [];
        let clientsDb = [];
        let currentUserRole = 'user'; // Track current user's role (admin or user)
        let currentId = null;
        let editingId = null; // Track document being edited
        let padTekniku, padKlienti;

        async function loadData() {
            const certsSnap = await getDocs(collection(firestore, 'clients'));
            db = certsSnap.docs.map(d => ({ ...d.data(), firestoreId: d.id }));

            const clientsSnap = await getDocs(collection(firestore, 'clientsDb'));
            clientsDb = clientsSnap.docs.map(d => ({ ...d.data(), firestoreId: d.id }));
        }

        async function persist() {
            // Firebase auto-persists, no action needed
        }

        // --- CORE UI ---
        function showDashboard() {
            document.querySelectorAll('#app > div').forEach(d => d.classList.add('hidden'));
            document.getElementById('dashboard-view').classList.remove('hidden');
            updateDashboardCount();
        }
        function showList() {
            document.querySelectorAll('#app > div').forEach(d => d.classList.add('hidden'));
            document.getElementById('list-view').classList.remove('hidden');
            renderList();
        }
        function showPanicList() {
            document.querySelectorAll('#app > div').forEach(d => d.classList.add('hidden'));
            document.getElementById('list-view').classList.remove('hidden');
            renderList(true);
        }
        function showClientManagement() {
            document.querySelectorAll('#app > div').forEach(d => d.classList.add('hidden'));
            document.getElementById('clients-mgmt-view').classList.remove('hidden');
            renderClientsTable();
        }
        function showClientForm(nui = null) {
            document.querySelectorAll('#app > div').forEach(d => d.classList.add('hidden'));
            document.getElementById('client-view').classList.remove('hidden');
            document.querySelectorAll('#client-view input').forEach(i => i.value = '');
            if (nui) {
                const c = clientsDb.find(x => x.nui === nui);
                if (c) {
                    ['klienti', 'nui', 'adresa', 'm2', 'tel', 'email'].forEach(k => {
                        const el = document.getElementById('c-' + k);
                        if (el) el.value = c[k] || '';
                    });
                }
            }
        }

        // --- LOGIC ---
        function getNextNr() {
            const yr = new Date().getFullYear().toString().slice(-2);
            let max = 0;
            db.forEach(d => {
                if (d.nr_v && d.nr_v.includes('/' + yr)) {
                    const match = d.nr_v.match(/(\d+)\//);
                    if (match) { const n = parseInt(match[1]); if (n > max) max = n; }
                }
            });
            return `Nr. ${String(max + 1).padStart(3, '0')}/${yr}`;
        }

        function createNew() {
            currentId = Date.now();
            clearForm();
            const tani = new Date();
            document.getElementById('f-data').value = tani.toISOString().split('T')[0];
            document.getElementById('f-ora').value = tani.toTimeString().slice(0, 5);
            document.getElementById('f-nr-v').value = getNextNr();
            document.getElementById('f-shenime').value = DEFAULT_NOTE;
            document.getElementById('f-stamp-toggle').checked = true;
            document.getElementById('f-validity').value = '6 Muaj';
            document.getElementById('f-price-na').checked = false;
            document.getElementById('f-cmimi').disabled = false;
            document.querySelectorAll('#app > div').forEach(d => d.classList.add('hidden'));
            document.getElementById('edit-view').classList.remove('hidden');
            setTimeout(initPads, 200);
        }

        function clearForm() {
            document.querySelectorAll('#edit-view input[type="text"], #edit-view input[type="date"], #edit-view input[type="time"], #edit-view input[type="email"], #edit-view textarea').forEach(i => i.value = '');
            document.querySelectorAll('#edit-view input[type="number"]').forEach(i => i.value = '');
            document.querySelectorAll('#edit-view input[type="checkbox"]').forEach(c => c.checked = false);
            if (padTekniku) padTekniku.clear(); if (padKlienti) padKlienti.clear();
            document.getElementById('custom-prep-container').innerHTML = '';
            FIXED_PREPS.forEach(p => togglePrepRow(p.replace(/\s/g, '_'), false));
        }

        function togglePriceNA(isNA) {
            const input = document.getElementById('f-cmimi');
            if (isNA) {
                input.disabled = true;
                input.value = '';
            } else {
                input.disabled = false;
            }
        }

        async function saveData() {
            const preps = Array.from(document.querySelectorAll('.prep-check:checked')).map(c => {
                const sid = c.dataset.name.replace(/\s/g, '_');
                const row = document.getElementById(`qty-row-${sid}`);
                return { emri: c.dataset.name, sasia: row.querySelector('.prep-qty').value, njesia: row.querySelector('.prep-unit').value };
            });
            document.querySelectorAll('.custom-prep-name').forEach(input => {
                const row = input.parentElement;
                if (input.value.trim()) preps.push({ emri: input.value.toUpperCase(), sasia: row.querySelector('.custom-prep-qty').value, njesia: row.querySelector('.custom-prep-unit').value });
            });

            const priceNA = document.getElementById('f-price-na').checked;
            const priceValue = priceNA ? 'N/A' : document.getElementById('f-cmimi').value;

            const docData = {
                id: currentId,
                data: document.getElementById('f-data').value,
                ora: document.getElementById('f-ora').value,
                nr_v: document.getElementById('f-nr-v').value,
                klienti: document.getElementById('f-klienti').value.toUpperCase().trim(),
                adresa: document.getElementById('f-adresa').value.toUpperCase().trim(),
                nui: document.getElementById('f-nui').value.toUpperCase().trim(),
                m2: document.getElementById('f-m2').value,
                tel: document.getElementById('f-tel').value,
                email: document.getElementById('f-email').value.toLowerCase().trim(),
                tekniku_emri: document.getElementById('f-tekniku-emri').value.toUpperCase(),
                pranuesi_emri: document.getElementById('f-pranuesi-emri').value.toUpperCase(),
                shenime: document.getElementById('f-shenime').value,
                cmimi: priceValue,
                price_is_na: priceNA,
                validity: document.getElementById('f-validity').value,
                sherbimet: Array.from(document.querySelectorAll('.sh-check:checked')).map(c => c.value),
                pestat: Array.from(document.querySelectorAll('.pest-check:checked')).map(c => c.value),
                metodat: Array.from(document.querySelectorAll('.metoda-check:checked')).map(c => c.value),
                preparatet: preps,
                show_stamp: document.getElementById('f-stamp-toggle').checked,
                sig_tekniku: padTekniku && !padTekniku.isEmpty() ? padTekniku.toDataURL() : null,
                sig_klienti: padKlienti && !padKlienti.isEmpty() ? padKlienti.toDataURL() : null,
                created_by: auth.currentUser ? auth.currentUser.email : 'unknown',
                timestamp: Timestamp.now(),
                ts: Date.now()
            };

            try {
                const existingDoc = db.find(x => x.id === currentId);
                if (existingDoc && existingDoc.firestoreId) {
                    await updateDoc(doc(firestore, 'clients', existingDoc.firestoreId), docData);
                    const idx = db.findIndex(x => x.id === currentId);
                    db[idx] = { ...docData, firestoreId: existingDoc.firestoreId };
                } else {
                    const docRef = await addDoc(collection(firestore, 'clients'), docData);
                    db.push({ ...docData, firestoreId: docRef.id });
                }

                if (docData.klienti) {
                    const existing = clientsDb.find(c => c.klienti === docData.klienti && c.adresa === docData.adresa);
                    const clientData = { klienti: docData.klienti, adresa: docData.adresa, nui: docData.nui, m2: docData.m2, tel: docData.tel, email: docData.email };

                    if (existing && existing.firestoreId) {
                        await updateDoc(doc(firestore, 'clientsDb', existing.firestoreId), clientData);
                        Object.assign(existing, clientData);
                    } else if (!existing) {
                        const clientRef = await addDoc(collection(firestore, 'clientsDb'), clientData);
                        clientsDb.push({ ...clientData, firestoreId: clientRef.id });
                    }
                }

                previewDoc(docData);
            } catch (error) {
                console.error("Error saving:", error);
                alert("Gabim gjatë ruajtjes: " + error.message);
            }
        }

        async function deleteDoc(id) {
            if (!confirm("Fshij këtë vërtetim?")) return;

            try {
                const docToDelete = db.find(x => x.id === id);
                if (docToDelete && docToDelete.firestoreId) {
                    await deleteFirestoreDoc(doc(firestore, 'clients', docToDelete.firestoreId));
                }
                db = db.filter(x => x.id !== id);
                renderList();
            } catch (error) {
                console.error("Error deleting:", error);
                alert("Gabim gjatë fshirjes: " + error.message);
            }
        }

        // --- SORTING ---
        function parseNrV(nrStr) {
            if (!nrStr) return { seq: 0, year: 0 };
            const m = nrStr.match(/(\d+)\/(\d+)/);
            if (m) return { seq: parseInt(m[1]), year: parseInt(m[2]) };
            return { seq: 0, year: 0 };
        }

        function renderList(onlyExpired = false) {
            const query = document.getElementById('search-input').value.toLowerCase();
            let filtered = db.filter(d => d.klienti.toLowerCase().includes(query) || d.nr_v.includes(query));
            if (onlyExpired) {
                const now = new Date();
                filtered = filtered.filter(d => {
                    const dDate = new Date(d.data);
                    const validityMonths = parseInt(d.validity) || 6;
                    return ((now - dDate) / (1000 * 60 * 60 * 24 * 30)) >= validityMonths;
                });
            }

            filtered.sort((a, b) => {
                const pA = parseNrV(a.nr_v);
                const pB = parseNrV(b.nr_v);
                if (pB.year !== pA.year) return pB.year - pA.year;
                return pB.seq - pA.seq;
            });

            document.getElementById('docs-list').innerHTML = filtered.map((d, index) => {
                const displayPrice = d.price_is_na ? 'N/A' : (d.cmimi ? `${d.cmimi} €` : '-');
                const createdBy = d.created_by || '-';
                const editButton = currentUserRole === 'admin'
                    ? `<button onclick="editDoc(${d.id})" class="text-yellow-600 hover:scale-110 transition-transform"><i class="fas fa-edit"></i></button>`
                    : '';
                const deleteButton = currentUserRole === 'admin'
                    ? `<button onclick="deleteDoc(${d.id})" class="text-red-600 hover:scale-110 transition-transform"><i class="fas fa-trash"></i></button>`
                    : '';
                return `
                <tr class="border-b hover:bg-gray-50 uppercase text-[11px] font-bold">
                    <td class="p-4"><span class="bg-black text-white px-2 py-1 rounded">${index + 1}</span></td>
                    <td class="p-4">${d.data}</td>
                    <td class="p-4">${d.klienti}</td>
                    <td class="p-4 text-xs lowercase">${createdBy}</td>
                    <td class="p-4">${displayPrice}</td>
                    <td class="p-4 text-center">
                        <div class="flex justify-center gap-3">
                            <button onclick="previewDoc(${d.id})" class="text-blue-600 hover:scale-110 transition-transform"><i class="fas fa-file-pdf"></i></button>
                            ${editButton}
                            ${deleteButton}
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        function editDoc(id) {
            const d = db.find(x => x.id === id); if (!d) return;
            currentId = id; clearForm();
            ['data', 'ora', 'nr_v', 'klienti', 'adresa', 'nui', 'm2', 'tel', 'email', 'tekniku_emri', 'pranuesi_emri', 'shenime'].forEach(k => {
                const el = document.getElementById('f-' + k); if (el) el.value = d[k] || '';
            });

            if (d.price_is_na) {
                document.getElementById('f-price-na').checked = true;
                document.getElementById('f-cmimi').disabled = true;
                document.getElementById('f-cmimi').value = '';
            } else {
                document.getElementById('f-price-na').checked = false;
                document.getElementById('f-cmimi').disabled = false;
                document.getElementById('f-cmimi').value = d.cmimi || '';
            }

            document.getElementById('f-validity').value = d.validity || '6 Muaj';
            document.getElementById('f-stamp-toggle').checked = (d.show_stamp !== false);
            d.sherbimet?.forEach(v => { const c = Array.from(document.querySelectorAll('.sh-check')).find(x => x.value === v); if (c) c.checked = true; });
            d.pestat?.forEach(v => { const c = Array.from(document.querySelectorAll('.pest-check')).find(x => x.value === v); if (c) c.checked = true; });
            d.metodat?.forEach(v => { const c = Array.from(document.querySelectorAll('.metoda-check')).find(x => x.value === v); if (c) c.checked = true; });
            d.preparatet?.forEach(p => {
                const c = document.querySelector(`.prep-check[data-name="${p.emri}"]`);
                if (c) {
                    c.checked = true; const sid = p.emri.replace(/\s/g, '_');
                    const row = document.getElementById(`qty-row-${sid}`);
                    if (row) { row.style.display = 'flex'; row.querySelector('.prep-qty').value = p.sasia; row.querySelector('.prep-unit').value = p.njesia; }
                } else { addNewPrepField(p.emri, p.sasia, p.njesia); }
            });
            document.querySelectorAll('#app > div').forEach(div => div.classList.add('hidden'));
            document.getElementById('edit-view').classList.remove('hidden');
            setTimeout(() => {
                initPads();
                if (d.sig_tekniku) padTekniku.fromDataURL(d.sig_tekniku);
                if (d.sig_klienti) padKlienti.fromDataURL(d.sig_klienti);
            }, 200);
        }

        function renderClientsTable() {
            document.getElementById('clients-table-container').innerHTML = clientsDb.map(c => `
                <div class="bg-gray-50 p-4 rounded-xl border-2 border-transparent hover:border-black flex justify-between items-center uppercase text-xs font-black transition-all">
                    <div><div>${c.klienti}</div><div class="text-[10px] text-gray-500">NUI: ${c.nui} | ${c.adresa}</div></div>
                    <div class="flex gap-2">
                        <button onclick="showClientForm('${c.nui}')" class="bg-black text-white px-4 py-2 rounded-lg">EDITO</button>
                        <button onclick="deleteClient('${c.nui}')" class="bg-red-600 text-white px-4 py-2 rounded-lg">FSHIJ</button>
                    </div>
                </div>`).join('');
        }

        async function handleSaveClient() {
            const c = {
                klienti: document.getElementById('c-klienti').value.trim().toUpperCase(),
                nui: document.getElementById('c-nui').value.trim().toUpperCase(),
                adresa: document.getElementById('c-adresa').value.trim().toUpperCase(),
                m2: document.getElementById('c-m2').value.trim(),
                tel: document.getElementById('c-tel').value.trim(),
                email: document.getElementById('c-email').value.trim().toLowerCase()
            };
            if (!c.klienti || !c.nui) return alert("Emri dhe NUI janë obligative!");

            try {
                const existing = clientsDb.find(x => x.klienti === c.klienti && x.adresa === c.adresa);
                if (existing && existing.firestoreId) {
                    await updateDoc(doc(firestore, 'clientsDb', existing.firestoreId), c);
                    Object.assign(existing, c);
                } else {
                    const clientRef = await addDoc(collection(firestore, 'clientsDb'), c);
                    clientsDb.push({ ...c, firestoreId: clientRef.id });
                }

                alert("Klienti u ruajt!");
                showClientManagement();
            } catch (error) {
                console.error("Error saving client:", error);
                alert("Gabim gjatë ruajtjes: " + error.message);
            }
        }

        async function deleteClient(nui) {
            if (!confirm("Fshij klientin?")) return;

            try {
                const clientToDelete = clientsDb.find(x => x.nui === nui);
                if (clientToDelete && clientToDelete.firestoreId) {
                    await deleteFirestoreDoc(doc(firestore, 'clientsDb', clientToDelete.firestoreId));
                }
                clientsDb = clientsDb.filter(x => x.nui !== nui);
                renderClientsTable();
            } catch (error) {
                console.error("Error deleting client:", error);
                alert("Gabim gjatë fshirjes: " + error.message);
            }
        }

        function updateDashboardCount() {
            const now = new Date();
            const count = db.filter(d => {
                const validityMonths = parseInt(d.validity) || 6;
                return (now - new Date(d.data)) / (1000 * 60 * 60 * 24 * 30) >= validityMonths;
            }).length;
            document.getElementById('dash-expired-count').innerText = count;
        }

        // --- FORMS UTILS ---
        function buildForms() {
            document.getElementById('sh-inputs').innerHTML = SH_TYPES.map(s => `<label class="flex items-center gap-2 p-2 border-2 border-gray-100 rounded-lg cursor-pointer bg-white hover:border-black transition-colors"><input type="checkbox" class="sh-check w-4 h-4 accent-black" value="${s}"><span class="text-[9px] font-bold uppercase select-none">${s}</span></label>`).join('');
            document.getElementById('pest-inputs').innerHTML = PEST_TYPES.map(p => `<label class="flex items-center gap-2 p-2 border-2 border-gray-100 rounded-lg cursor-pointer bg-white hover:border-black transition-colors"><input type="checkbox" class="pest-check w-4 h-4 accent-black" value="${p}"><span class="text-[9px] font-bold uppercase select-none">${p}</span></label>`).join('');
            document.getElementById('metoda-inputs').innerHTML = METODA_TYPES.map(m => `<label class="flex items-center gap-2 p-3 border-2 border-gray-100 rounded-xl cursor-pointer bg-white hover:border-black transition-colors"><input type="checkbox" class="metoda-check w-5 h-5 accent-black" value="${m}"><span class="text-[11px] font-black uppercase select-none">${m}</span></label>`).join('');
            document.getElementById('prep-inputs').innerHTML = FIXED_PREPS.map(p => {
                const sid = p.replace(/\s/g, '_');
                return `<div class="p-3 border-2 border-gray-100 rounded-xl bg-white"><label class="flex items-center gap-2 mb-2 cursor-pointer"><input type="checkbox" class="prep-check w-4 h-4 accent-black" data-name="${p}" onchange="togglePrepRow('${sid}', this.checked)"><span class="text-[9px] font-black uppercase select-none">${p}</span></label>
                <div id="qty-row-${sid}" class="hidden gap-2"><input type="text" placeholder="Sasia" class="prep-qty p-1.5 text-xs border-2 border-gray-300 rounded w-16 font-bold"><select class="prep-unit p-1.5 text-[9px] border-2 border-gray-300 rounded font-bold flex-1">${UNIT_TYPES.map(u => `<option value="${u}">${u}</option>`).join('')}</select></div></div>`;
            }).join('');
        }
        function togglePrepRow(sid, show) { const r = document.getElementById(`qty-row-${sid}`); if (r) r.style.display = show ? 'flex' : 'none'; }
        function addNewPrepField(n = "", q = "", u = "LITËR") {
            const div = document.createElement('div'); div.className = "p-3 border-2 border-gray-100 rounded-xl bg-gray-50";
            div.innerHTML = `<input type="text" class="custom-prep-name w-full p-2 text-[10px] border-2 border-gray-300 rounded mb-2 font-black uppercase" placeholder="EMRI" value="${n}"><div class="flex gap-2"><input type="text" class="custom-prep-qty p-2 text-xs border-2 border-gray-300 rounded w-16 font-bold" value="${q}"><select class="custom-prep-unit p-2 text-[9px] border-2 border-gray-300 rounded flex-1">${UNIT_TYPES.map(x => `<option value="${x}" ${u === x ? 'selected' : ''}>${x}</option>`).join('')}</select><button onclick="this.parentElement.parentElement.remove()" class="text-red-500 px-2"><i class="fas fa-times"></i></button></div>`;
            document.getElementById('custom-prep-container').appendChild(div);
        }
        function handleFuzzySearch(v) {
            const r = document.getElementById('fuzzy-results'); if (!v) { r.classList.add('hidden'); return; }
            const q = v.toLowerCase();
            const m = clientsDb.filter(c => c.klienti.toLowerCase().includes(q) || c.nui.toLowerCase().includes(q));
            if (m.length) {
                const unique = [...new Map(m.map(item => [item['klienti'] + item['adresa'], item])).values()];
                r.innerHTML = unique.map(c => `<div onclick="selectFuzzy('${c.klienti}', '${c.adresa}')" class="p-3 border-b hover:bg-gray-100 cursor-pointer"><div>${c.klienti}</div><div class="text-[9px] text-gray-400">NUI: ${c.nui} | ${c.adresa}</div></div>`).join('');
                r.classList.remove('hidden');
            } else r.classList.add('hidden');
        }
        function selectFuzzy(k, a) {
            const c = clientsDb.find(x => x.klienti === k && x.adresa === a);
            if (c) { ['klienti', 'adresa', 'nui', 'm2', 'tel', 'email'].forEach(key => { const el = document.getElementById('f-' + key); if (el) el.value = c[key] || ''; }); }
            document.getElementById('fuzzy-results').classList.add('hidden');
        }
        function initPads() {
            const ct = document.getElementById('sig-tekniku'), ck = document.getElementById('sig-klienti');
            if (!ct || !ck) return;
            const res = (c, p) => { const r = Math.max(window.devicePixelRatio || 1, 1); c.width = c.offsetWidth * r; c.height = c.offsetHeight * r; c.getContext("2d").scale(r, r); };
            if (!padTekniku) padTekniku = new SignaturePad(ct, { penColor: '#0000CD' });
            if (!padKlienti) padKlienti = new SignaturePad(ck, { penColor: '#0000CD' });
            res(ct, padTekniku); res(ck, padKlienti);
        }
        function clearSig(t) { if (t === 'tekniku') padTekniku.clear(); else padKlienti.clear(); }

        // --- PDF ENGINE ---
        async function getBase64FromUrl(url) {
            const res = await fetch(url);
            const blob = await res.blob();
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.readAsDataURL(blob);
            });
        }

        async function previewDoc(idOrData) {
            const d = typeof idOrData === 'object' ? idOrData : db.find(x => x.id === idOrData); if (!d) return;

            // Use jsPDF directly for strict layout control
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'mm', format: 'a4' });

            // Fonts
            doc.setFont("helvetica", "bold");

            // LOGOS
            try {
                const logoData = await getBase64FromUrl(LOGO_URL);
                doc.addImage(logoData, 'PNG', 55, 10, 100, 25); // Centered Logo
            } catch (e) { console.error("Logo Error", e); }

            if (d.show_stamp !== false) {
                try {
                    const stampData = await getBase64FromUrl(STAMP_URL);
                    doc.addImage(stampData, 'PNG', 150, 230, 40, 40); // Bottom Right
                } catch (e) { console.error("Stamp Error", e); }
            }

            // HEADER INFO
            doc.setFontSize(10);
            doc.text(`Nr. ${d.nr_v}`, 170, 20, { align: 'right' });

            doc.setFontSize(16);
            doc.text("VËRTETIM PËR KRYERJEN E SHËRBIMEVE DDD", 105, 45, { align: 'center' });

            // DATA/ORA BOX
            doc.setDrawColor(0); doc.setFillColor(249, 250, 251); doc.rect(40, 50, 130, 10, 'FD');
            doc.setFontSize(11);
            doc.text(`DATA: ${d.data.split('-').reverse().join('.')}`, 50, 56.5);
            doc.text(`ORA: ${d.ora}`, 120, 56.5);

            // CLIENT BOX
            doc.rect(15, 65, 180, 28);
            doc.setFontSize(10);
            let cy = 72;
            doc.text(`KLIENTI:   ${d.klienti}`, 18, cy); cy += 7;
            doc.text(`ADRESA:   ${d.adresa}`, 18, cy); cy += 7;
            doc.text(`NUI: ${d.nui}        M²: ${d.m2}        TEL: ${d.tel}`, 18, cy);

            // GRID (Sherbimi / Pests)
            doc.rect(15, 98, 90, 30); // Left Box
            doc.rect(105, 98, 90, 30); // Right Box

            // Left content
            doc.setFontSize(9);
            doc.text("SHËRBIMI", 18, 103);
            doc.line(15, 105, 105, 105);
            let sy = 109;
            doc.setFontSize(7);
            SH_TYPES.forEach((s, i) => {
                const isChecked = d.sherbimet && d.sherbimet.includes(s) ? "X" : " ";
                doc.text(`[${isChecked}] ${s}`, 18, sy);
                sy += 3.5;
            });

            // Right content
            doc.setFontSize(9);
            doc.text("PESTAT", 108, 103);
            doc.line(105, 105, 195, 105);
            let py = 109;
            doc.setFontSize(7);
            PEST_TYPES.forEach((p, i) => {
                const isChecked = d.pestat && d.pestat.includes(p) ? "X" : " ";
                const px = i < 6 ? 108 : 150;
                const py_real = i < 6 ? (py + (i * 3.5)) : (py + ((i - 6) * 3.5));
                doc.text(`[${isChecked}] ${p}`, px, py_real);
            });

            // CHEMICALS (PREPARATET)
            const startY = 132;
            doc.setFillColor(0); doc.rect(15, startY, 180, 6, 'F');
            doc.setTextColor(255);
            doc.setFontSize(9);
            doc.text("PREPARATI", 18, startY + 4);
            doc.text("NJËSIA", 140, startY + 4);
            doc.text("SASIA", 170, startY + 4);

            doc.setTextColor(0);
            let yPos = startY + 10;
            doc.setFontSize(8); // FONT SIZE 8 (User request)

            if (d.preparatet && d.preparatet.length > 0) {
                d.preparatet.forEach(p => {
                    const chemText = p.emri;
                    const splitChems = doc.splitTextToSize(chemText, 120);

                    doc.text(splitChems, 18, yPos);
                    doc.text(p.njesia || '-', 140, yPos);
                    doc.text(p.sasia || '-', 170, yPos);

                    yPos += (splitChems.length * 4) + 2; // TIGHT SPACING
                });
            } else {
                doc.text("Nuk ka preparate", 18, yPos);
            }

            // METHODS
            yPos = Math.max(yPos, startY + 14);
            yPos += 5;
            doc.rect(15, yPos, 180, 8);
            doc.setFontSize(8);
            const methodsText = "METODA: " + METODA_TYPES.map(m => `[${d.metodat && d.metodat.includes(m) ? 'X' : ' '}] ${m}`).join('   ');
            doc.text(methodsText, 18, yPos + 5);

            // NOTES
            if (d.shenime) {
                yPos += 12;
                doc.setFontSize(8);
                doc.text("SHËNIME:", 18, yPos);
                const splitNotes = doc.splitTextToSize(d.shenime, 175);
                doc.text(splitNotes, 18, yPos + 4);
            }

            // FOOTER (Signatures & Price) - RESET yPos (User request)
            yPos = 240;

            // Signatures
            doc.setFontSize(10);
            const technicianName = d.tekniku_emri || '';
            const techSigImg = d.sig_tekniku;

            if (techSigImg) {
                try { doc.addImage(techSigImg, 'PNG', 25, yPos - 15, 40, 15); } catch (e) { }
            }
            doc.line(20, yPos, 80, yPos);
            doc.text(`TEKNIKU: ${technicianName}`, 25, yPos + 5);

            const clientName = d.pranuesi_emri || '';
            const clientSigImg = d.sig_klienti;
            if (clientSigImg) {
                try { doc.addImage(clientSigImg, 'PNG', 125, yPos - 15, 40, 15); } catch (e) { }
            }
            doc.line(120, yPos, 180, yPos);
            doc.text(`PRANUESI: ${clientName}`, 125, yPos + 5);

            // Price & Validity
            yPos += 20;
            const priceTxt = d.price_is_na ? "N/A" : (d.cmimi ? `${d.cmimi} €` : "0.00 €");
            const validityTxt = d.validity || "6 Muaj";

            doc.setFontSize(11);
            doc.text(`ÇMIMI: ${priceTxt}     |     VLEFSHMËRIA: ${validityTxt}`, 105, yPos, { align: 'center' });

            // Footer Info
            doc.setFontSize(7);
            doc.setTextColor(100);
            doc.text("NUI 811498957 | RR. MEHMET AKIF ERSOY NR. 17, TASLIXHE II - PRISHTINË | +383 44 158 638", 105, 290, { align: 'center' });

            doc.save(`Vertetim_${d.nr_v.replace(/\//g, '-')}_${d.klienti.replace(/\s+/g, '_')}.pdf`);
        }

        // AUTH FUNCTIONS
        async function handleLogin() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            const errorDiv = document.getElementById('login-error');

            if (!email || !password) {
                errorDiv.textContent = 'Ju lutem plotësoni të gjitha fushat!';
                errorDiv.classList.remove('hidden');
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
                errorDiv.classList.add('hidden');
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = 'E-mail ose fjalëkalimi i gabuar!';
                errorDiv.classList.remove('hidden');
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error('Logout error:', error);
                alert('Gabim gjatë daljes: ' + error.message);
            }
        }

        function openPasswordModal() {
            document.getElementById('password-modal').classList.remove('hidden');
            document.getElementById('new-password-input').value = '';
            document.getElementById('new-password-input').focus();
        }

        function closePasswordModal() {
            document.getElementById('password-modal').classList.add('hidden');
            document.getElementById('new-password-input').value = '';
        }

        async function saveNewPassword() {
            const newPassword = document.getElementById('new-password-input').value;

            if (!newPassword || newPassword.length < 6) {
                alert('Fjalëkalimi duhet të ketë të paktën 6 karaktere!');
                return;
            }

            const user = auth.currentUser;
            if (!user) {
                alert('Ju lutem identifikohuni fillimisht!');
                closePasswordModal();
                return;
            }

            try {
                await updatePassword(user, newPassword);
                alert('Fjalëkalimi u ndryshua me sukses!');
                closePasswordModal();
            } catch (error) {
                console.error('Password update error:', error);
                if (error.code === 'auth/requires-recent-login') {
                    alert('Për arsye sigurie, ju lutem dilni dhe hyni përsëri, pastaj provoni të ndryshoni fjalëkalimin.');
                } else {
                    alert('Gabim gjatë ndryshimit të fjalëkalimit: ' + error.message);
                }
            }
        }

        async function checkAdminAccess(userEmail) {
            const clientMgmtBtn = document.getElementById('btn-client-mgmt');
            if (!clientMgmtBtn) return;

            try {
                const userDocRef = doc(firestore, 'users', userEmail);
                const userDocSnap = await getDoc(userDocRef);

                const isAdmin = userDocSnap.exists() && userDocSnap.data().roli === 'admin';
                currentUserRole = isAdmin ? 'admin' : 'user'; // Set global role
                clientMgmtBtn.style.display = isAdmin ? 'flex' : 'none';
            } catch (error) {
                console.error('Error checking admin access:', error);
                currentUserRole = 'user'; // Default to user on error
                clientMgmtBtn.style.display = 'none';
            }
        }

        // AUTH STATE OBSERVER
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('dashboard-view').classList.remove('hidden');

                checkAdminAccess(user.email);

                if (db.length === 0) {
                    await loadData();
                }
                updateDashboardCount();
            } else {
                // User is signed out
                document.getElementById('dashboard-view').classList.add('hidden');
                document.getElementById('login-view').classList.remove('hidden');
            }
        });

        window.onload = () => {
            buildForms();
        };

        // Expose functions to global scope for onclick handlers
        window.handleLogin = handleLogin;
        window.handleLogout = handleLogout;
        window.openPasswordModal = openPasswordModal;
        window.closePasswordModal = closePasswordModal;
        window.saveNewPassword = saveNewPassword;
        window.createNew = createNew;
        window.showClientManagement = showClientManagement;
        window.showPanicList = showPanicList;
        window.showList = showList;
        window.showDashboard = showDashboard;
        window.saveData = saveData;
        window.showClientForm = showClientForm;
        window.handleSaveClient = handleSaveClient;
        window.deleteClient = deleteClient;
        window.previewDoc = previewDoc;
        window.editDoc = editDoc;
        window.deleteDoc = deleteDoc;
        window.renderList = renderList;
        window.handleFuzzySearch = handleFuzzySearch;
        window.selectFuzzy = selectFuzzy;
        window.togglePriceNA = togglePriceNA;
        window.addNewPrepField = addNewPrepField;
        window.togglePrepRow = togglePrepRow;
        window.clearSig = clearSig;
    </script>
</body>

</html>
